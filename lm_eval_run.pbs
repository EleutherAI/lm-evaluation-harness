#!/bin/bash
#PBS -P CFP01-CF-060
#PBS -j oe
#PBS -k oed
#PBS -N lm_evaluation_harness_run
#PBS -q auto
#PBS -l select=1:ngpus=4
#PBS -l walltime=56:00:00

cd $PBS_O_WORKDIR

image="/app1/common/singularity-img/hopper/pytorch/pytorch_2.3.0_cuda_12.4_ngc_24.04.sif"

module load singularity

BASE_LOG_DIR="/scratch/e1583535/multilingual-llm-project/logs/eval/lm-evaluation-harness/xcopa_pre-translation_en/0shot/vi"

mkdir -p $BASE_LOG_DIR

OUTPUT_PATH="/scratch/e1583535/results/lm_evaluation_harness/xcopa_pre-translation-0shot/vi"

mkdir -p $OUTPUT_PATH

TASKS="xnli_en,xnli_th,xnli_vi,xnli_zh,xcopa_en,xcopa_id,xcopa_ta,xcopa_th,xcopa_vi,xcopa_zh,"
TASKS="${TASKS}xcopa_7b-5shot_id_en,xcopa_7b-5shot_ta_en,xcopa_7b-5shot_th_en,xcopa_7b-5shot_vi_en,xcopa_7b-5shot_zh_en,"
TASKS="${TASKS}xcopa_google_id_en,xcopa_google_ta_en,xcopa_google_th_en,xcopa_google_vi_en,xcopa_google_zh_en,"
TASKS="${TASKS}xnli_7b_5shot_th_en,xnli_7b_5shot_vi_en,xnli_7b_5shot_zh_en,"
TASKS="${TASKS}xnli_google_th_en,xnli_google_vi_en,xnli_google_zh_en"

singularity exec -e \
--env HF_HOME=/scratch/e1583535/cache \
--env HF_DATASETS_CACHE=/scratch/e1583535/cache/datasets \
$image bash << EOF > $BASE_LOG_DIR/stdout.$PBS_JOBID.log 2> $BASE_LOG_DIR/stderr.$PBS_JOBID.log

if [ -d "/hpctmp/e1583535/virtualenvs/sea-helm" ]; then
    source /hpctmp/e1583535/virtualenvs/sea-helm/bin/activate
fi

echo "Starting evaluating at $(date)"
echo "Running on host: $(hostname)"
echo "GPU info:"
nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv,noheader,nounits || echo "No GPU detected"

lm_eval --model hf \
--model_args pretrained=meta-llama/Llama-3.1-8B-Instruct,parallelize=True \
--tasks $TASKS \
--output_path $OUTPUT_PATH \
--batch_size 16 

EOF