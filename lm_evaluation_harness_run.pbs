#!/bin/bash
#PBS -P CFP01-CF-060
#PBS -j oe
#PBS -k oed
#PBS -N lm_evaluation_harness_run
#PBS -q auto
#PBS -l select=1:ngpus=8
#PBS -l walltime=56:00:00

cd $PBS_O_WORKDIR

image="/app1/common/singularity-img/hopper/pytorch/pytorch_2.3.0_cuda_12.4_ngc_24.04.sif"

module load singularity

XNLI_FULL_TEST_LOG="/scratch/e1583535/multiLingual-llm-project/logs/eval/lm-evaluation-harness/xnli_full_test"

mkdir -p $XNLI_FULL_TEST_LOG

XNLI_FULL_TEST_OUTPUT_PATH="/scratch/e1583535/results/lm_evaluation_harness/xnli_full_test"

mkdir -p $XNLI_FULL_TEST_OUTPUT_PATH

singularity exec -e \
--env HF_HOME=/scratch/e1583535/cache \
--env HF_DATASETS_CACHE=/scratch/e1583535/cache/datasets \
$image bash << EOF > $XNLI_FULL_TEST_LOG/stdout.$PBS_JOBID.log 2> $XNLI_FULL_TEST_LOG/stderr.$PBS_JOBID.log

if [ -d "/hpctmp/e1583535/virtualenvs/sea-helm" ]; then
    source /hpctmp/e1583535/virtualenvs/sea-helm/bin/activate
fi

echo "Starting evaluating at $(date)"
echo "Running on host: $(hostname)"
echo "GPU info:"
nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv,noheader,nounits || echo "No GPU detected"

# Remember use limit=100 for abstract summarization task to avoid OOM

lm_eval --model hf \
--model_args pretrained=/scratch/e1583535/llm/nus-olmo/para-only-7B-34B-checkpoints/step6201-unsharded-hf,parallelize=True \
--tasks xnli_en,xnli_th,xnli_vi,xnli_zh \
--output_path $XNLI_FULL_TEST_OUTPUT_PATH \
--batch_size 16 

EOF