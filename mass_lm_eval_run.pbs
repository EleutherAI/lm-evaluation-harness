#!/bin/bash
#PBS -P CFP01-CF-060
#PBS -j oe
#PBS -k oed
#PBS -N lm_evaluation_harness_run
#PBS -q auto
#PBS -l select=1:ngpus=2
#PBS -l walltime=56:00:00

cd "$PBS_O_WORKDIR"

image="/app1/common/singularity-img/hopper/pytorch/pytorch_2.3.0_cuda_12.4_ngc_24.04.sif"

module load singularity

if [ -z "$MODEL" ]; then
    echo "ERROR: MODEL not set"
    exit 1
fi

if [ -z "$TASKS" ]; then
    echo "ERROR: TASKS not set"
    exit 1
fi

if [ -z "$OUTPUT_PATH" ]; then
    echo "ERROR: OUTPUT_PATH not set"
    exit 1
fi

# Convert space-separated TASKS â†’ comma-separated for lm_eval
TASKS_CSV=$(echo "$TASKS" | tr ' ' ',')

singularity exec -e \
  --env HF_HOME=/scratch/e1583535/cache \
  --env HF_DATASETS_CACHE=/scratch/e1583535/cache/datasets \
  "$image" bash << EOF > "$BASE_LOG_DIR/stdout.$PBS_JOBID.log" 2> "$BASE_LOG_DIR/stderr.$PBS_JOBID.log"

if [ -d "/hpctmp/e1583535/virtualenvs/sea-helm" ]; then
    source /hpctmp/e1583535/virtualenvs/sea-helm/bin/activate
fi

echo "Starting evaluating at \$(date)"
echo "Running on host: \$(hostname)"
echo "GPU info:"
nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv,noheader,nounits || echo "No GPU detected"

lm_eval --model hf \
  --model_args pretrained=$MODEL,parallelize=True \
  --tasks $TASKS_CSV \
  --log_samples \
  --output_path $OUTPUT_PATH \
  --batch_size 16

EOF
